#!/bin/sh
# Minimal udhcpc script for lanproxy netns.
# IMPORTANT: do not touch /etc/resolv.conf because the filesystem is shared.

set -eu

IFACE="${interface:-}"
IP="${ip:-}"
SUBNET="${subnet:-}"

NS_GW="${NS_GW:-192.168.1.250}"

mask2cidr() {
  # $1: dotted-quad netmask
  # shellcheck disable=SC2039
  case "$1" in
    255.255.255.255) echo 32 ;;
    255.255.255.254) echo 31 ;;
    255.255.255.252) echo 30 ;;
    255.255.255.248) echo 29 ;;
    255.255.255.240) echo 28 ;;
    255.255.255.224) echo 27 ;;
    255.255.255.192) echo 26 ;;
    255.255.255.128) echo 25 ;;
    255.255.255.0) echo 24 ;;
    255.255.254.0) echo 23 ;;
    255.255.252.0) echo 22 ;;
    255.255.248.0) echo 21 ;;
    255.255.240.0) echo 20 ;;
    255.255.224.0) echo 19 ;;
    255.255.192.0) echo 18 ;;
    255.255.128.0) echo 17 ;;
    255.255.0.0) echo 16 ;;
    255.254.0.0) echo 15 ;;
    255.252.0.0) echo 14 ;;
    255.248.0.0) echo 13 ;;
    255.240.0.0) echo 12 ;;
    255.224.0.0) echo 11 ;;
    255.192.0.0) echo 10 ;;
    255.128.0.0) echo 9 ;;
    255.0.0.0) echo 8 ;;
    *) echo 24 ;; # fallback
  esac
}

case "${1:-}" in
  deconfig)
    [ -n "$IFACE" ] || exit 0
    ip addr flush dev "$IFACE" 2>/dev/null || true
    ip route del default 2>/dev/null || true
    ;;
  bound|renew)
    [ -n "$IFACE" ] || exit 0
    [ -n "$IP" ] || exit 0

    cidr="$(mask2cidr "$SUBNET")"
    ip addr flush dev "$IFACE" 2>/dev/null || true
    ip addr add "$IP/$cidr" dev "$IFACE"
    ip link set "$IFACE" up

    # Force the default route via OpenWrt (bypass upstream DHCP router option).
    ip route replace default via "$NS_GW"
    ;;
  *)
    ;;
esac

